#!/bin/bash
# borja@libcrack.so
# Wed jul 30 17:31:16 CEST 2014
#
# Explore the filesystem for sqlite
# databases and dump the contents

test -z "$1" && {
    echo -e "\n\tUso: $0 <directory> <bool show content>\n"
    exit 1
}

targetdir="$1"
showcontent="$2"
dbfiles="dbfiles.$$"

echo "[*] Discovering sqlite databases at $targetdir ..."
find "$targetdir" -exec file {} \; | grep -i sqlite | cut -f1 -d: > $dbfiles

while read dbfile; do
    echo -e "[*] Analysing database $dbfile =========================================\n\n"
    echo -e "[*] database schema  $dbfile -----------------------------------------------------"
    echo .schema | sqlite3 "$dbfile"
    echo -e "[*] ----------------------------------------------------------------------\n\n"

    if [ "$showcontent" == "true" ]; then
        tables=$(echo .schema | sqlite3 "$dbfile" | grep TABLE  | awk '{print $3}' | cut -f1 -d \()
        for t in $tables; do
            echo -e "[*] table $dbfile:$t -----------------------------------------\n"
            echo -e ".headers ON\n.mode columns\nselect * from $t;" | sqlite3 "$dbfile"
            echo;echo
        done
    fi

done < $dbfiles
rm $dbfiles
