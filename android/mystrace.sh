#!/bin/sh
# devnull@libcrack.so
#
# Android strace wrapper
#

test -z "$1" && {
    echo -e "\n\tUsage: $0 <app name>\n"
    exit 1
    }

trap captura INT
captura(){
    echo " "
    echo "[*] Pulling ${strace_logfile}"
    adb shell pull "${strace_logfile}" .
}

app="$1"
pid=
pid_strace=

num=$RANDOM
logdir=.
strace_logfile="/sdcard/strace_${app}.$$.${num}.log"
logcat_logfile="${logdir}/logcat_${app}.$$.${num}.log"
syscalls="open,access,read,write,socket,poll,select,connect,recvfrom,sendto"
ignore="SFPerfTracer|TraceEventNetworkController|dalvikvm|WifiStateMachine\
|WifiP2pService|wpa_supplicant|qdhwcomposer|CydiaSubstrate|AlarmManager|MDMCTBK\
|ConnectivityService|Nat464Xlat|ModemStatsDSDetect|audio_hw_primary|audio_hw_extn\
|msm8974_platfor"

test -d ${logdir} || mkdir -p ${logdir}

pid_strace=$(adb shell ps | grep strace | awk '{print $2}')
test -z "$pid_strace" || {
    echo "[*] Killing previous strace process pid=$pid_strace"
    adb shell su -c kill -9 "$pid_strace"
}

pid=$(adb shell ps | grep $app | awk '{print $2}')
test -z "$pid" && {
    echo "ERROR: cannot get pid of $app"
    exit 2
}

echo "[*] Tracing app=${app} pid=${pid}"
echo "[*] logcat log=${logcat_logfile}"
echo "[*] strace log=${strace_logfile}"

adb shell su -c "strace -e $syscalls -p $pid -o $strace_logfile" &
sleep 3

echo "[*] Now execute:"
echo 'adb logcat >> ${logcat_logfile} 2>&1 &'
echo 'tail -f '${logcat_logfile}' | egrep -v "'${ignore}'" | logcat-colorize'
echo
