--
-- author: Borja <borja@libcrack.so>
-- date:   sab abr 18 13:21:34 CEST 2015
--

--
-- The Head Section
--

local http = require 'http'
local shortport = require 'shortport'
local stdnse = require 'stdnse'
local string = require 'string'
local vulns = require 'vulns'
-- local openssl   = stdnse.silent_require 'openssl'

description = [[
'
Checks for Microsoft IIS web servers vulnerables to MS15-034

CVE-2015-1635 : IIS HTTP.sys remote code execution through invalid HTTP "Range" request header

Reference :
    https://technet.microsoft.com/en-us/library/security/ms15-034.aspx
    https://technet.microsoft.com/library/security/MS15-034
    https://support.microsoft.com/en-us/kb/3042553
    http://blog.erratasec.com/2015/04/masscanning-for-ms15-034.html#.VTIBS3VjOXA
    http://blog.beyondtrust.com/the-delicate-art-of-remote-checks-a-glance-into-ms15-034
    https://ma.ttias.be/remote-code-execution-via-http-request-in-iis-on-windows/
    http://www.exploit-db.com/exploits/36773/
']]

---
-- @usage
-- nmap -p 80 --script=./http-ms15-034.nse <target>
--
-- @output
-- PORT   STATE SERVICE REASON
-- 80/tcp open  http    syn-ack
-- | http-ms15-034:
-- |   VULNERABLE:
-- |   MS15-034 Remote Desktop Protocol Remote Code Execution Vulnerability
-- |     State: VULNERABLE
-- |     IDs:  MS:MS15-034  CVE:CVE-2015-1635
-- |     Risk factor: High  CVSSv2: 10.0 (HIGH) (AV:N/AC:L/Au:N/C:C/I:C/A:C)
-- |               'HTTP.sys in Microsoft Windows 7 SP1, Windows Server 2008 R2 SP1, Windows 8, Windows 8.1, and Windows Server 2012 Gold and R2 allows remote attackers to execute arbitrary code via crafted HTTP requests.'
-- |
-- |     Disclosure date: 2015-04-14
-- |     References:
-- |       https://technet.microsoft.com/library/security/MS15-034
-- |       http://www.exploit-db.com/exploits/36773/
-- |       https://ma.ttias.be/remote-code-execution-via-http-request-in-iis-on-windows/
-- |       http://blog.beyondtrust.com/the-delicate-art-of-remote-checks-a-glance-into-ms15-034
-- |       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-1635
-- |       https://technet.microsoft.com/en-us/library/security/ms15-034.aspx
-- |_      http://blog.erratasec.com/2015/04/masscanning-for-ms15-034.html#.VTIBS3VjOXA
-- Final times for host: srtt: 186694 rttvar: 140204  to: 747510
---

author = 'Borja Ruiz <borja@libcrack.so>'
license = 'Same as Nmap - See http://nmap.org/book/man-legal.html'
categories = {'default', 'safe', 'discovery'}

--
-- The Rule Section
--

portrule = shortport.port_or_service({80,443},{'http','https','ssl/http'},{'tcp'})

-- portrule = function (host, port)
--     return (port.number == 80 or port.number == 443 or
--         port.service == nil or port.service == '' or
--         port.service == 'unknown')
--        and port.protocol == 'tcp' and port.state == 'open'
--        and port.service ~= 'http' and port.service ~= 'ssl/http'
-- end

--
-- The Action Section
--

action = function(host, port)

    local report = vulns.Report:new(SCRIPT_NAME, host, port)
    local vuln_table = {
        title = "MS15-034 Remote Desktop Protocol Remote Code Execution Vulnerability",
        IDS = {
            CVE = 'CVE-2015-1635',
            MS = 'MS15-034',
        },
        risk_factor = "High",
        scores = {
            CVSSv2 = "10.0 (HIGH) (AV:N/AC:L/Au:N/C:C/I:C/A:C)",
        },
        description = [[
        'HTTP.sys in Microsoft Windows 7 SP1, Windows Server 2008 R2 SP1, Windows 8, Windows 8.1, and Windows Server 2012 Gold and R2 allows remote attackers to execute arbitrary code via crafted HTTP requests.'
        ]],
        references = {
            'https://technet.microsoft.com/en-us/library/security/ms15-034.aspx',
            'https://technet.microsoft.com/library/security/MS15-034',
            'http://blog.erratasec.com/2015/04/masscanning-for-ms15-034.html#.VTIBS3VjOXA',
            'http://blog.beyondtrust.com/the-delicate-art-of-remote-checks-a-glance-into-ms15-034',
            'https://ma.ttias.be/remote-code-execution-via-http-request-in-iis-on-windows/',
            'http://www.exploit-db.com/exploits/36773/',
        },
        dates = {
            disclosure = {year = '2015', month = '04', day = '14'},
        }
    }

    local uri = '/'
    local flag = '.*Requested Range Not Satisfiable.*'
    local options = {header={}}
    options['header']['Host'] = host.ip
    options['header']['User-Agent']  = 'Mozilla/4.0 (compatible; MSIE 6.0; Mac_PowerPC; en) Opera 9.24'
    options['header']['Content-Type'] = 'text/html; charset=UTF-8'
    options['header']['Range'] = 'bytes=0-18446744073709551615'
    options['header']['Connection'] = 'close'

    local response = http.get(host, port, uri, options)

    if response.status == 416 then
        stdnse.print_debug(1, SCRIPT_NAME .. ': response status: ' .. response.status)
        stdnse.print_debug(1, SCRIPT_NAME .. ': response status-line: ' .. string.gsub(response['status-line'],"\r\n",""))
        stdnse.print_debug(1, SCRIPT_NAME .. ': response body: \n\n'.. response.body)
        if string.match(response.body,flag) then
            vuln_table.state = vulns.STATE.VULN
        else
            vuln_table.state = vulns.STATE.VULN
        end
    end

    return report:make_output(vuln_table)

end
