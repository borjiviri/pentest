#!/usr/bin/env bash
# root@libcrack.so

[[ ! -f "$1" ]] && {
    echo -e "\n\tUsage: $0 <iplist.txt>\n"
    exit 1
}

trap captura INT
function captura () { printf "\e[1;31m Exiting\e[0m\n"; exit 1; }

sudo=`which sudo`
nmap=`which nmap`
screen=`which screen`
iplist="$1"

declare -A tools

# On a LAN, 100 milliseconds (--max-rtt-timeout 100ms) is a reasonable aggressive value.
# Generally, not set the maximum RTT below 100 ms, nor exceed 1000 ms.
#
# --initial-rtt-timeout => double of the maximum round trip time out of ten packets
# --max-rtt-timeout     => triple or quadruple f the maximum round trip time out of ten packets
# --min-rtt-timeout     => rarely used,could be useful when a network very unreliable
# --host-timeout <time> => specify 30m to ensure that no more than half an hour on a single host
# --max-retries <num>   => specify the maximum number of port scan probe retransmissions
#
# Time to wait between each probe Nmap sends to a given host
# A low --max-scan-delay can speed up Nmap, but it is risky
# Another use of --scan-delay is to evade threshold based IDS
# --scan-delay <time>
# --max-scan-delay <time>
#
# These two options are global, affecting an entire scan, not individual hosts.
# Specifying a minimum rate should be done with care
# --min-rate <number>   => send packets as fast as or faster than the given rate
# --max-rate <number>   => limits a scan's sending rate to a given maximum
# --max-rate 100        => limit to 100pps
#
#  Wait for ICMP error messages or SYN responses for a limited time
#  Useful on SYN scans or UDP scans
# --defeat-rst-ratelimit
#
# If you want want to ramp the scan speed up further, increase
# --min-hostgroup
# --min-parallelism
# but keep them in a 4:1 ratio
# I wouldn't recommend more than 4096/1024
#
# A common choice is 256 to scan a network in Class C sized chunks.
# For a scan with many ports, exceeding that number is unlikely to help.
# For scans of just a few port numbers, host group sizes of 2048
#
# --min-hostgroup 256 --min-parallelism 64
# --min-hostgroup 128 --min-parallelism 32
# --min-hostgroup 64  --min-parallelism 16
#
#
# Nmap scans the most common 1000 ports for each protocol.
# Nmap -F scans only 100 ports
#
# The default timing template is -T3
# -T0 and -T1 are slow but good for avoid IDS alerts
# On broadband use -T4 , on ethernet use -T5
#
# T4
#   --initial-rtt-timeout 500ms
#   --max-rtt-timeout 1250ms
#   --max-retries 6
#   --max-scan-delay 10ms
#
# T5
#   --initial-rtt-timeout 250ms
#   --min-rtt-timeout 50ms
#   --max-rtt-timeout 300ms
#   --max-retries 2
#   --max-scan-delay 5ms
#   --host-timeout 15m


# T5 timing
tools[nmap_fast_tcp]="$nmap -Pn -n -sS
-vvv -d
--open
--initial-rtt-timeout 30ms
--min-rtt-timeout 50ms
--max-rtt-timeout 300ms
--max-retries 2
--max-scan-delay 5ms
--host-timeout 15m
--defeat-rst-ratelimit
--min-hostgroup 64
--min-parallelism 64
-iL $iplist -oA nmap_fast_tcp"

# T4 timing
tools[nmap_full_tcp]="$nmap -Pn -n  -p- -sS
-vvv -d
--open
--initial-rtt-timeout 50ms
--max-rtt-timeout 500ms
--max-retries 6
--max-scan-delay 10ms
--defeat-rst-ratelimit
--min-hostgroup 64
--min-parallelism 64
-iL $iplist -oA nmap_full_tcp"

# T4
#   --initial-rtt-timeout 500ms
#   --max-rtt-timeout 1250ms
#   --max-retries 6
#   --max-scan-delay 10ms
# T5
#   --initial-rtt-timeout 250ms
#   --min-rtt-timeout 50ms
#   --max-rtt-timeout 300ms
#   --max-retries 2
#   --max-scan-delay 5ms
#   --host-timeout 15m

# T3 < Tx < T4
tools[nmap_fast_udp]="$nmap -Pn -n -sU
-vvv -d
--open
--initial-rtt-timeout 1000ms
--max-rtt-timeout 2000ms
--max-retries 6
--max-scan-delay 20ms
--min-hostgroup 64
--min-parallelism 64
-iL $iplist -oA nmap_fast_udp"

## T4 timing
#tools[nmap_full_udp]="$nmap -Pn -n -sU -p-
#-vvv -d
#--initial-rtt-timeout 500ms
#--max-rtt-timeout 1250ms
#--max-retries 6
#--max-scan-delay 10ms
#--min-hostgroup 64
#--min-parallelism 64
#-iL $iplist -oA nmap_full_udp"

# T3 < Tx < T4 - no sC
tools[nmap_udp]="$nmap -Pn -n -sU
-vvv -d
--open
--initial-rtt-timeout 1000ms
--max-rtt-timeout 2000ms
--max-retries 6
--max-scan-delay 30ms
--min-hostgroup 64
--min-parallelism 64
-p 7,9,13,49,53,67,68,69,88,111,117,123,135,137,138,139,161,177,259,427,445,500,513,514,520,523,631,750,1027,1060,1434,1604,1701,1720,1745,1812,2049,2171,2172,2173,2746,3847,4045,4569,5060,5353,7001,7145,17185,18233,18234,31337,32770,32771,32772,32776,41524
-iL $iplist -oA nmap_udp"


printf "\e[31m[*] Tune --initial-rtt-timeout for a better performance (check with ~10 pings)\e0m\n"

for tool in "${!tools[@]}"; do
    printf "\e[31m[*] starting ${tool}\e[0m\n"
    sudo screen -d -m -S "$tool" ${tools[$tool]}
done

printf "\e[31m[*] Screens running:\e[0m\n"
screen -ls

exit 0
