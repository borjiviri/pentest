#!/usr/bin/env bash

dirname="$1"
jarfile="$1.jar"
apifile="burp_extender_api.zip"
apifileurl="http://portswigger.net/burp/extender/api/burp_extender_api.zip"
makefile="Makefile"
antfile="build.xml"

[[ -z "$1" || -z "$2" ]] && {
    echo -e "\n\tUsage: $0 <extension name> <[makefile|ant]>\n"
    exit 1
}

[[ -d "$1" ]] && {
    echo -e "\n\t[!] ERROR: The directory $dirname already exists\n"
    exit 2
}

[[ -e $apifile ]] || {
    echo -e "\n\t[!] ERROR: Cannot find $apifile in $PWD"
    echo -e "\t[!] Download it from the following URL to this very same folder\n"
    echo -e "\t$apifileurl\n"
    exit 3
}

echo "[*] Creating extension structure for $dirname"

mkdir "$dirname"
"$(which unzip)" "$apifile" -d "$dirname/"
cd $dirname

case "$2" in

    ant)
        echo "[*] Using ANT build process"
        mkdir src bin dist
        mv burp/ src/
        touch "src/burp/BurpExtender.java"
        touch "src/${dirname}.java"
        cat > $antfile << _EOF
<?xml version="1.0" encoding="UTF-8"?>
<project name="${dirname}" default="JarBuilder">
  <target name="JarBuilder" description="Creates the jar file for burp">
        <jar jarfile="dist/${dirname}.jar" includes="**/*.class" basedir="src"/>
  </target>
</project>
_EOF
        echo "[*] To build the jar file enter $dirname and execute \"ant\""
        echo "[*] Now edit $dirname/burp/BurpExtender.java and src/${dirname}.java"
        ;;

    makefile)
        echo "[*] Using old Makefile build process"
        touch "BurpExtender.java"
        cat > "$makefile" << _EOF
all:
	@echo "[*] Compiling burp extension $dirname"
	@javac -d burp/ BurpExtender.java
	@echo "[*] Creating $jarfile"
	@jar -cf $jarfile burp/*.class
	@echo "[*] Execute \"java -cp $jarfile:burpsuite_pro.jar burp.StartBurp\" to start burp"
clean:
	@echo "[*] Cleaning $dirname"
	@rm burp/*.class
	@rm $jarfile
_EOF
        echo "[*] To build the jar file enter $dirname and execute \"make\""
        echo "[*] Now edit $dirname/BurpExtender.java"
        ;;
    *)
        rm -rf "$dirname"
        printf "\n\tUsage: $0 <extension name> <makefile|ant>\n\n"
        exit 2
        ;;
esac


exit 0
