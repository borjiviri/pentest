#!/bin/bash
#
# borja@libcrack.so
#
# vie nov  8 08:45:35 CET 2013
# mar ene 21 23:14:46 CET 2014

## TODO REFs: ~/.java/.userPrefs/burp/prefs.xml
## ~/.java/.userPrefs $ grep burp burp/prefs.xml
## <entry key="proxy.disableburpinterface" value="false"/>
## <entry key="proxy.supresssburperrors" value="false"/>
## <entry key="suite.autoSaveFolder" value="/home/user/workdir/burp"/>
## <entry key="workingdirectory" value="/home/borja/user/workdir/burp"/>

java="$(which java)"
version="$($java -version 2>&1 | head -1 | cut -f2 -d\")"
myself="$(realpath ${0#-*})"
workdir="$(dirname $myself)"

# ----------------------------------------------------
# MaxPerm sets the PermGen heap which is separate and
#   in addition to the main heap space set with Xmx
# Its a good idea to assign the same valie for
#   Xms and Xmx
# ----------------------------------------------------
# -XX:+AggressiveHeap   # heap allocator tunning
# -Xms3072M             # initial heap space
# -Xmx3072M             # maximum heap space
# -XX:PermSize=1024M    # initial permanent space
# -XX:MaxPermSize=1024M # maximum permanent space

RAM="4096"
let PRAM="${RAM}/2"
JFLAGS="-Xms${RAM}M -Xmx${RAM}M -XX:PermSize=${PRAM}M -XX:MaxPermSize=$((PRAM*2))M -XX:+AggressiveHeap"
#JFLAGS="-Xmx${RAM}M -Xms${RAM}M -XX:+AggressiveHeap -XX:MaxPermSize=${PRAM}M"
JPROXY1="-Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=9090"
JPROXY2="-Dhttp.nonProxyHosts=\"localhost|127.0.0.1|10.*.*.*|*.foo.com\""
JDEBUG="-Xdebug -agentlib:jdwp=transport=dt_socket,server=y,address=8000,suspend=n"
HEADLESS="-Djava.awt.headless=true"

# PermGemSpace does not exist in Java 1.8
[[ $version =~ 1.8 ]] \
    && JFLAGS="-Xms${RAM}M -Xmx${RAM}M -XX:+AggressiveHeap"

# ---- BURP PRO ---------------------------------
cd $workdir
burpjarpro=$(ls burpsuite_pro*.jar|tail -1)
burpjarfree=$(ls burpsuite_free*.jar|tail -1)
burpjar="null.jar"
args=

echo
echo "[*] Starting Burp Suite"
echo "------------------------"

case "$1" in
        debug)
            echo "    >> DEBUG mode selected"
            JFLAGS="$JFLAGS $JDEBUG"
            ;;
        free)
            echo "    >> burp free selected"
            burpjar="$burpjarfree"
            ;;
        pro)
            echo "    >> burp pro selected"
            burpjar="$burpjarpro"
            ;;
        *)
            echo "    >> burp pro auto selected"
            burpjar="$burpjarpro"
            ;;
esac

[[ -e $burpjar ]] || {
    echo "    >> ERROR: cannot locate burp jar file" ; echo
    exit 1
    }

args="${JFLAGS} -jar ${burpjar}"

echo "    >> java version=${version}"
echo "    >> java options=${args}"
echo "    >> burp cwd=${workdir}"
echo "    >> burp jar=${burpjar}"
echo

${java} ${args} &

exit $?
