#!/usr/bin/env python2
# jue ago 28 19:27:37 CEST 2014
# borja@libcrack.so
#
# Reads an Burp Suite issues XML file and
# print all the issues, payloads and details
# based on previous work by Pablo Catalina
#


import sys
import re
from base64 import b64decode
from xml.dom import minidom
import html2text
import urllib

if len(sys.argv) != 2:
    print ("\n\tUsage: %s <items.xml>\n" % sys.argv[0])
    sys.exit(1)

filename = sys.argv[1]
xmldoc = minidom.parse(filename)
idict={}

try:
    itemlist = xmldoc.getElementsByTagName('item')
except Exception as e:
    raise Exception("%s does not contain items" % filename)

for item in itemlist:

    tmpitem = {}

    tmpitem['url'] = item.getElementsByTagName('url')[0].firstChild.data
    tmpitem['host'] = item.getElementsByTagName('host')[0].firstChild.data
    #tmpitem['request'] = b64decode(item.getElementsByTagName('request')[0].firstChild.data)
    #tmpitem['response'] = b64decode(item.getElementsByTagName('response')[0].firstChild.data)
    #tmpitem['referer'] = re.search(r"Referer:\s*(.*)\n", tmpitem['request']).groups()[0]

    host = tmpitem['host']

    if host not in idict.keys():
        idict[host]=tmpitem
    else:
        print ("[ERROR] host %s already added" % (host))

number = 0
for host in sorted(idict.keys()):
    print ("-------------------------------------[ HTTP Request Snip ]-------------------------------------")
    print (" Instance number %s" % number)
    print (" Host: %s" % idict[host]['host'])
    print (" URL: %s" % urllib.unquote_plus(idict[host]['url']))
    #print (" Referer: %s" % idict[host]['referer'])
    print ("-------------------------------------[ HTTP Request Snip ]-------------------------------------")
    print ("\n")
    #print ("=============================================================================================")
    #print ("\n[*] HTTP Request to %s :\n" % url)
    ##print ("<code>")
    #print ("-----------------------------------[ SNIP STARTS ]-----------------------------------")
    #print ("%s" % idict[host][''][0],)
    #print ("------------------------------------[ SNIP ENDS ]------------------------------------")
    ##print ("</code>")
    #print
    #print ("[*] HTTP Response to %s :" % url)
    #print
    ##print ("<code>")
    #print ("-----------------------------------[ SNIP STARTS ]-----------------------------------")
    #print ("%s" % idict[url][param][1],)
    #print ("------------------------------------[ SNIP ENDS ]------------------------------------")
    ##print ("</code>")
    #print ("\n[*] Issue detail :\n")
    #print ("%s\n\n" % idict[url][param][2])
    number = number + 1

