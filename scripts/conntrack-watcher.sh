#!/usr/bin/env bash
# devnull@libcrack.so
# dom ago 31 04:17:57 CEST 2014

[[ "$(whoami)" == "root" ]] || {
    echo "Got root?"
    exit 1
}

#maximun="$(sysctl -n net.ipv4.netfilter.ip_conntrack_max)"
maximun="$(sysctl -n net.nf_conntrack_max)"
current="$(conntrack -C)"
thresold="$(($maximun/4 * 3))"
date=$(date "+%d/%m/%Y %H:%M:%S")

rcpt="CHANGEME@EMAIL.COM"
subject="ALERT: Connection tracking thresold reached"
msg="maximun=$maximun current=$current thresold=$thresold"
body="\n$date\t$msg\n\n$(conntrack -C)\n\n$(conntrack -S)\n"

logtag="conntrack"

mailalert(){ echo -e "$body" | mail -s "$subject" "$rcpt"; }

if [[ $current > $thresold ]]; then
    logger --stderr --tag "$logtag" --priority daemon.alert "$subject"
    logger --stderr --tag "$logtag" --priority daemon.alert "$msg"
    mailalert
else
    logger --stderr --tag "$logtag" --priority daemon.info "$msg"
fi

exit 0
