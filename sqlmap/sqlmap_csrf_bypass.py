#!/usr/bin/env python2
#
#   python2 ./sqlmap.py -l post_request.txt \
#        -v 6 --level=5 --risk=2 \
#        --eval="import csrf; Serial=csrf.getCSRF()"
#

import httplib
from StringIO import StringIO
import gzip

from lxml import html

def getCSRF():
    conn = httplib.HTTPSConnection("www.w3schools.com")
    headers = {"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                "Accept-Language": "en-US,en;q=0.5",
                "Accept-Encoding": "gzip, deflate",
                "Referer": "https://www.w3schools.com/tags/demo_form.asp",
                "Connection": "keep-alive"
                }

    conn.request("GET", "/tags/demo.asp", None, headers)
    resp = conn.getresponse()
    buffer = StringIO(resp.read())
    deflatedContent = gzip.GzipFile(fileobj=buffer)
    content_text = deflatedContent.read()
    content_tree = html.fromstring(content_text)
    csrf_token = content_tree.xpath('//input[@name="csrf"]/@value')
    conn.close()

    return csrf_token[0]
